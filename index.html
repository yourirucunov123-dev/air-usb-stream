<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AirUSB Live Mobile</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #00ff88; --bg: #000; --panel: #121212; --text: #eee; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* Видео-зона (сверху на мобилках) */
        #video-section { 
            position: relative; width: 100%; aspect-ratio: 16/9; 
            background: #000; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid #333;
        }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* Контейнер приложения */
        #app-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* Чат */
        #chat-section { flex: 1; display: flex; flex-direction: column; background: var(--panel); }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { 
            padding: 10px 14px; background: #222; border-radius: 18px; font-size: 14px; 
            max-width: 85%; align-self: flex-start; line-height: 1.4;
        }
        .msg.me { align-self: flex-end; background: #005c4b; border-bottom-right-radius: 4px; }
        .msg.host { border-left: 3px solid var(--primary); background: #1a251e; }

        #input-area { 
            padding: 10px 15px 25px 15px; background: #1e1e1e; 
            display: flex; gap: 10px; align-items: center;
        }
        input { 
            flex: 1; background: #333; border: none; color: #fff; 
            padding: 12px 18px; border-radius: 25px; font-size: 16px; outline: none;
        }

        /* Кнопки */
        .btn { 
            background: var(--primary); color: #000; border: none; 
            padding: 12px 20px; border-radius: 25px; font-weight: bold; font-size: 14px;
        }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* Оверлеи */
        #overlay { 
            position: absolute; inset: 0; background: var(--bg); 
            z-index: 100; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; padding: 20px; text-align: center;
        }
        #end-screen { 
            position: fixed; inset: 0; background: #000; z-index: 999; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
        }

        .status-badge { 
            position: absolute; top: 10px; left: 10px; background: rgba(255,0,0,0.8);
            padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: bold;
        }
        
        #qrcode-box { background: white; padding: 10px; border-radius: 12px; margin: 15px 0; }
    </style>
</head>
<body>

    <div id="end-screen">
        <h2 style="color:var(--primary)">Эфир завершен</h2>
        <p>Ведущий покинул трансляцию</p>
        <button class="btn" onclick="location.href=location.origin+location.pathname" style="margin-top:20px">На главную</button>
    </div>

    <div id="video-section">
        <div id="live-tag" class="status-badge" style="display:none;">LIVE</div>
        <video id="remoteVideo" autoplay playsinline></video>
        <div id="placeholder" style="color:#444; font-weight:bold;">AIRUSB LIVE</div>
    </div>

    <div id="app-content">
        <div id="overlay">
            <h2 id="title">AirUSB <span style="color:var(--primary)">Live</span></h2>
            
            <div id="nick-step">
                <input type="text" id="nickInput" placeholder="Введите ваш ник">
                <button id="nextBtn" class="btn" style="margin-top:15px; width:100%">Войти</button>
            </div>

            <div id="host-step" style="display:none;">
                <div id="qrcode-box"></div>
                <button id="startBtn" class="btn" style="width:100%">Начать трансляцию</button>
                <button id="shareBtn" class="btn" style="margin-top:10px; width:100%; background:#222; color:#fff;">Поделиться ссылкой</button>
            </div>

            <div id="viewer-step" style="display:none;">
                <p>Вы подключены как зритель</p>
                <p style="color:var(--primary); font-size:12px">Ожидайте запуска потока...</p>
            </div>
        </div>

        <div id="chat-section">
            <div id="messages"></div>
            <div id="input-area">
                <input type="text" id="msgInput" placeholder="Сообщение...">
                <button id="sendBtn" class="btn send-btn">></button>
            </div>
        </div>
    </div>

    <script>
        const peer = new Peer();
        let connections = [];
        let myStream = null;
        let nick = "";
        const isViewer = !!new URLSearchParams(window.location.search).get('join');

        // Элементы управления
        const overlay = document.getElementById('overlay');
        const endScreen = document.getElementById('end-screen');
        const video = document.getElementById('remoteVideo');

        peer.on('open', (id) => {
            document.getElementById('nextBtn').onclick = () => {
                nick = document.getElementById('nickInput').value || "User_" + id.slice(0,3);
                showStep(id);
            };
        });

        function showStep(myId) {
            document.getElementById('nick-step').style.display = 'none';
            if (isViewer) {
                document.getElementById('viewer-step').style.display = 'block';
                connectToHost(new URLSearchParams(window.location.search).get('join'));
            } else {
                document.getElementById('host-step').style.display = 'block';
                const url = window.location.origin + window.location.pathname + '?join=' + myId;
                new QRCode(document.getElementById("qrcode-box"), { text: url, width: 150, height: 150 });
                document.getElementById('shareBtn').onclick = () => navigator.share({ url });
                document.getElementById('startBtn').onclick = startLive;
            }
        }

        async function startLive() {
            try {
                myStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                overlay.style.display = 'none';
                document.getElementById('live-tag').style.display = 'block';
                document.getElementById('placeholder').style.display = 'none';
                
                // Передаем стрим всем, кто уже ждет
                connections.forEach(conn => peer.call(conn.peer, myStream));
                
                // Следим за кнопкой "Остановить" в браузере
                myStream.getVideoTracks()[0].onended = closeAll;
            } catch (e) { alert("Ошибка доступа"); }
        }

        function connectToHost(hostId) {
            const conn = peer.connect(hostId);
            handleConn(conn);
        }

        function handleConn(conn) {
            conn.on('open', () => {
                connections.push(conn);
                addMsg("Система", "Вы присоединились к чату");
            });

            conn.on('data', (data) => {
                if (data.type === 'chat') addMsg(data.user, data.text, data.isHost);
                if (data.type === 'signal' && data.content === 'end') {
                    showEnd();
                }
            });

            // Если хост пропал (закрыл вкладку)
            conn.on('close', showEnd);
            conn.on('error', showEnd);
        }

        // Входящие звонки (для зрителя)
        peer.on('call', (call) => {
            call.answer();
            call.on('stream', (s) => {
                overlay.style.display = 'none';
                video.style.display = 'block';
                video.srcObject = s;
                document.getElementById('live-tag').style.display = 'block';
            });
        });

        // Входящие сообщения (для хоста)
        peer.on('connection', (conn) => {
            handleConn(conn);
            if (myStream) peer.call(conn.peer, myStream);
        });

        function addMsg(user, text, isHostMsg = false) {
            const m = document.createElement('div');
            m.className = `msg ${user === nick ? 'me' : ''} ${isHostMsg ? 'host' : ''}`;
            m.innerHTML = `<small style="display:block; opacity:0.6; font-size:10px">${user}</small>${text}`;
            const box = document.getElementById('messages');
            box.appendChild(m);
            box.scrollTop = box.scrollHeight;
        }

        function showEnd() {
            endScreen.style.display = 'flex';
        }

        function closeAll() {
            connections.forEach(c => c.send({ type: 'signal', content: 'end' }));
            setTimeout(() => location.reload(), 300);
        }

        // Отправка сообщений
        document.getElementById('sendBtn').onclick = () => {
            const inp = document.getElementById('msgInput');
            if (!inp.value) return;
            addMsg(nick, inp.value);
            connections.forEach(c => c.send({ type: 'chat', text: inp.value, user: nick, isHost: !isViewer }));
            inp.value = "";
        };

        // Детекция закрытия вкладки
        window.addEventListener('beforeunload', () => {
            if (!isViewer) closeAll();
        });
    </script>
</body>
</html>
