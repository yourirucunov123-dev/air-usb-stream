<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AirUSB Live</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #00ff88; --bg: #0a0a0a; --panel: #161616; }
        
        * { box-sizing: border-box; }

        body { 
            margin: 0; 
            background: var(--bg); 
            color: #fff; 
            font-family: system-ui, -apple-system, sans-serif; 
            height: 100vh; 
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        #app-container { display: flex; flex: 1; position: relative; overflow: hidden; }

        #main { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            background: #000; 
        }

        video { width: 100%; height: 100%; object-fit: contain; display: none; }

        /* –ß–ê–¢ */
        #chat-side { 
            width: 320px; 
            background: var(--panel); 
            border-left: 1px solid #333; 
            display: flex; 
            flex-direction: column; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        #messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            -webkit-overflow-scrolling: touch;
        }

        .msg { padding: 10px 14px; background: #222; border-radius: 15px; font-size: 0.9em; max-width: 85%; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: #004d33; border-bottom-right-radius: 2px; }
        .msg.host { border-left: 3px solid var(--primary); background: #1a2a1a; }
        .msg.system { align-self: center; background: transparent; color: #777; font-size: 0.75em; border: none; }

        /* –ü–û–õ–ï –í–í–û–î–ê */
        #chat-input { 
            padding: 12px 12px calc(env(safe-area-inset-bottom, 0px) + 35px) 12px; 
            background: #1a1a1a; 
            border-top: 1px solid #333; 
            display: flex; 
            gap: 8px; 
        }

        input { 
            flex: 1; 
            background: #222; 
            border: 1px solid #444; 
            color: #fff; 
            padding: 12px 18px; 
            border-radius: 25px; 
            outline: none; 
            font-size: 16px; 
        }

        /* –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ - –º–æ–±–∏–ª—å–Ω–∞—è */
        #toggle-chat {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom, 0px) + 90px); /* –ü–æ–¥–Ω—è—Ç–∞ –≤—ã—à–µ –≤–≤–æ–¥–∞ */
            right: 20px;
            z-index: 2000;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: #000;
            border: none;
            display: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }

        /* –°—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏, –∫–æ–≥–¥–∞ —á–∞—Ç –û–¢–ö–†–´–¢ (–ø–µ—Ä–µ–µ–∑–∂–∞–µ—Ç –Ω–∞–≤–µ—Ä—Ö) */
        #toggle-chat.active {
            bottom: auto;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            font-size: 18px;
            background: #333;
            color: #fff;
        }

        @media (max-width: 768px) {
            #toggle-chat { display: flex; align-items: center; justify-content: center; }
            #chat-side {
                position: fixed;
                inset: 0;
                width: 100%;
                transform: translateX(100%);
            }
            #chat-side.active { transform: translateX(0); }
        }

        .btn { background: var(--primary); color: #000; border: none; padding: 12px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; }
        
        #setup { text-align: center; padding: 25px; background: var(--panel); border-radius: 20px; width: 85%; max-width: 350px; z-index: 10; }
        #qrcode { background: white; padding: 10px; border-radius: 10px; margin: 15px 0; display: inline-block; }
        #viewer-count { position: absolute; top: 20px; left: 20px; background: rgba(255,0,0,0.8); padding: 5px 12px; border-radius: 20px; font-size: 0.8em; z-index: 50; display:none; }
        
        #end-screen { 
            position: fixed; inset: 0; background: #000; 
            display: none; flex-direction: column; align-items: center; 
            justify-content: center; z-index: 9999; text-align: center;
        }
    </style>
</head>
<body>

    <div id="end-screen">
        <h1 style="color: var(--primary)">–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h1>
        <p>–í–µ–¥—É—â–∏–π –æ—Ç–∫–ª—é—á–∏–ª—Å—è</p>
        <button class="btn" onclick="location.href=location.origin + location.pathname">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
    </div>

    <button id="toggle-chat">üí¨</button>

    <div id="app-container">
        <div id="main">
            <div id="viewer-count">LIVE: 0</div>
            
            <div id="setup">
                <h2>AirUSB <span style="color:var(--primary)">Live</span></h2>
                <div id="user-init">
                    <input type="text" id="nickInput" placeholder="–í–∞—à –Ω–∏–∫..." style="width:100%">
                    <button id="joinService" class="btn" style="width:100%; margin-top:10px">–í–æ–π—Ç–∏</button>
                </div>
                
                <div id="host-controls" style="display:none;">
                    <div id="qrcode"></div>
                    <button id="startStream" class="btn" style="width:100%">–ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é</button>
                    <button id="shareBtn" class="btn" style="width:100%; margin-top:10px; background:#0088ff; color:#fff">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                </div>

                <div id="viewer-controls" style="display:none;">
                    <p id="status-text">–û–∂–∏–¥–∞–Ω–∏–µ —ç—Ñ–∏—Ä–∞...</p>
                </div>
            </div>

            <video id="remoteVideo" autoplay playsinline controls></video>
        </div>

        <div id="chat-side">
            <div style="padding: 15px; border-bottom: 1px solid #333; font-size: 0.8em; display:flex; justify-content: space-between; align-items: center; background: var(--panel);">
                <span>–ß–ê–¢</span>
                <span id="myNameDisplay" style="color:var(--primary); margin-right: 40px;"></span>
            </div>
            <div id="messages"></div>
            <div id="chat-input">
                <input type="text" id="msgText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="btn" id="sendBtn">></button>
            </div>
        </div>
    </div>

    <script>
        const peer = new Peer();
        let connections = [];
        let myStream = null;
        let myNickname = "";
        const isHostMode = !new URLSearchParams(window.location.search).get('join');

        // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —á–∞—Ç–∞
        const chatSide = document.getElementById('chat-side');
        const toggleBtn = document.getElementById('toggle-chat');
        
        toggleBtn.onclick = () => {
            const isOpen = chatSide.classList.toggle('active');
            toggleBtn.classList.toggle('active', isOpen);
            toggleBtn.innerText = isOpen ? '‚úï' : 'üí¨';
            
            if(isOpen) {
                setTimeout(() => document.getElementById('messages').scrollTop = 99999, 100);
            }
        };

        function showEndScreen() {
            document.getElementById('end-screen').style.display = 'flex';
            if (myStream) myStream.getTracks().forEach(t => t.stop());
        }

        function addMessage(text, sender, type = '') {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = `<b style="display:block;color:var(--primary);font-size:0.75em">${sender}</b>${text}`;
            const msgBox = document.getElementById('messages');
            msgBox.appendChild(div);
            msgBox.scrollTop = msgBox.scrollHeight;
        }

        peer.on('open', (id) => {
            document.getElementById('joinService').onclick = () => {
                myNickname = document.getElementById('nickInput').value || "–ì–æ—Å—Ç—å";
                initSession(id);
            };
        });

        function initSession(myId) {
            document.getElementById('user-init').style.display = 'none';
            document.getElementById('myNameDisplay').innerText = myNickname;
            const joinId = new URLSearchParams(window.location.search).get('join');

            if (joinId) {
                setupConnection(peer.connect(joinId));
                document.getElementById('viewer-controls').style.display = 'block';
            } else {
                document.getElementById('host-controls').style.display = 'block';
                const url = window.location.origin + window.location.pathname + '?join=' + myId;
                new QRCode(document.getElementById("qrcode"), { text: url, width: 128, height: 128 });
                document.getElementById('startStream').onclick = startCapture;
                document.getElementById('shareBtn').onclick = () => {
                    if (navigator.share) navigator.share({ url });
                    else { navigator.clipboard.writeText(url); alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!"); }
                };
            }
        }

        async function startCapture() {
            try {
                myStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                document.getElementById('setup').style.display = 'none';
                document.getElementById('remoteVideo').style.display = 'block';
                document.getElementById('remoteVideo').srcObject = myStream;
                document.getElementById('viewer-count').style.display = 'block';
                myStream.getVideoTracks()[0].onended = () => endSession();
                connections.forEach(c => peer.call(c.peer, myStream));
            } catch (e) { alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞"); }
        }

        function endSession() {
            connections.forEach(c => c.send({ type: 'system_cmd', action: 'end' }));
            setTimeout(() => location.reload(), 500);
        }

        window.onbeforeunload = () => { if (isHostMode) endSession(); };

        function setupConnection(conn) {
            conn.on('open', () => {
                connections.push(conn);
                addMessage("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ", "–°–∏—Å—Ç–µ–º–∞", "system");
                
                document.getElementById('sendBtn').onclick = () => {
                    const val = document.getElementById('msgText').value;
                    if(!val) return;
                    const name = isHostMode ? myNickname + " (–í–µ–¥—É—â–∏–π)" : myNickname;
                    const data = { type: 'chat', text: val, user: name };
                    conn.send(data);
                    addMessage(val, "–í—ã", isHostMode ? "me host" : "me");
                    if (isHostMode) connections.forEach(c => { if(c !== conn) c.send(data); });
                    document.getElementById('msgText').value = "";
                };
            });

            conn.on('data', (data) => {
                if (data.type === 'chat') {
                    addMessage(data.text, data.user, data.user.includes('(–í–µ–¥—É—â–∏–π)') ? 'host' : '');
                    if (isHostMode) connections.forEach(c => { if(c !== conn) c.send(data); });
                }
                if (data.type === 'system_cmd' && data.action === 'end') showEndScreen();
            });

            conn.on('close', () => { if (!isHostMode) showEndScreen(); });
        }

        peer.on('connection', (conn) => {
            setupConnection(conn);
            document.getElementById('viewer-count').style.display = 'block';
            document.getElementById('viewer-count').innerText = `LIVE: ${connections.length}`;
            if (myStream) setTimeout(() => peer.call(conn.peer, myStream), 1000);
        });

        peer.on('call', (call) => {
            call.answer();
            call.on('stream', (s) => {
                document.getElementById('setup').style.display = 'none';
                document.getElementById('remoteVideo').style.display = 'block';
                document.getElementById('remoteVideo').srcObject = s;
            });
        });

        document.getElementById('msgText').onkeypress = (e) => { if(e.key === 'Enter') document.getElementById('sendBtn').click(); };
    </script>
</body>
</html>
